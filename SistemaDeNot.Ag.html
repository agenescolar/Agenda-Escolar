<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Escolar - Sistema de Notificações</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --accent: #f72585;
            --success: #4cc9f0;
            --warning: #f9c74f;
            --danger: #f94144;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --white: #ffffff;
            --card-shadow: 0 10px 20px rgba(0, 0, 0, 0.05), 0 6px 6px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
        }
        
        header {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(120deg, var(--primary), var(--secondary));
            color: var(--white);
        }
        
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        header h1 i {
            background: var(--white);
            color: var(--primary);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .admin-panel {
            padding: 30px;
        }
        
        .data-section {
            margin-bottom: 30px;
            background: var(--white);
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
        }
        
        .data-section h2 {
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-gray);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .data-content {
            background: var(--light);
            padding: 20px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        
        .btn {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: var(--white);
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
            margin-right: 10px;
            margin-bottom: 10px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(67, 97, 238, 0.4);
        }
        
        .btn-danger {
            background: var(--danger);
            box-shadow: 0 4px 10px rgba(249, 65, 68, 0.3);
        }
        
        .btn-danger:hover {
            box-shadow: 0 6px 15px rgba(249, 65, 68, 0.4);
        }
        
        .btn-success {
            background: var(--success);
            box-shadow: 0 4px 10px rgba(76, 201, 240, 0.3);
        }
        
        .btn-success:hover {
            box-shadow: 0 6px 15px rgba(76, 201, 240, 0.4);
        }
        
        .btn-warning {
            background: var(--warning);
            color: var(--dark);
            box-shadow: 0 4px 10px rgba(249, 199, 79, 0.3);
        }
        
        .btn-warning:hover {
            box-shadow: 0 6px 15px rgba(249, 199, 79, 0.4);
        }
        
        .message {
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            text-align: center;
            font-weight: 500;
        }
        
        .success {
            background-color: rgba(76, 201, 240, 0.15);
            color: #0a7ea6;
            border-left: 4px solid var(--success);
        }
        
        .error {
            background-color: rgba(249, 65, 68, 0.15);
            color: #c82333;
            border-left: 4px solid var(--danger);
        }
        
        .warning {
            background-color: rgba(249, 199, 79, 0.15);
            color: #8a6d3b;
            border-left: 4px solid var(--warning);
        }
        
        .instructions {
            background-color: rgba(76, 201, 240, 0.15);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid var(--success);
        }
        
        .instructions h3 {
            color: var(--dark);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .instructions ul {
            margin-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 350px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.prova {
            background: linear-gradient(to right, var(--danger), #e02d30);
        }
        
        .notification.trabalho {
            background: linear-gradient(to right, var(--success), #0a7ea6);
        }
        
        .notification .close {
            margin-left: auto;
            cursor: pointer;
        }
        
        .notification-bell {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 999;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            header h1 {
                font-size: 2rem;
            }
            
            .admin-panel {
                padding: 20px;
            }
            
            .btn {
                width: 100%;
                margin-right: 0;
                justify-content: center;
            }
            
            .notification {
                left: 20px;
                right: 20px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-bell"></i> Sistema de Notificações</h1>
            <p>Configure e visualize as notificações dos seus eventos</p>
        </header>
        
        <section class="admin-panel">
            <div class="instructions">
                <h3><i class="fas fa-info-circle"></i> Como funcionam as notificações</h3>
                <p>O sistema verificará automaticamente eventos que acontecerão no próximo dia e exibirá notificações:</p>
                <ul>
                    <li>Notificações são exibidas quando você está logado</li>
                    <li>Você receberá um alerta 24 horas antes de cada evento</li>
                    <li>As notificações são salvas para que você não as veja repetidamente</li>
                    <li>Clique no sino no canto inferior direito para ver notificações recentes</li>
                </ul>
            </div>
            
            <div class="message" id="message"></div>
            
            <div class="data-section">
                <h2><i class="fas fa-cog"></i> Configurações de Notificação</h2>
                <button class="btn btn-success" onclick="enableNotifications()">
                    <i class="fas fa-bell"></i> Ativar Notificações
                </button>
                <button class="btn btn-warning" onclick="testNotification()">
                    <i class="fas fa-test"></i> Testar Notificação
                </button>
                <button class="btn" onclick="checkUpcomingEvents()">
                    <i class="fas fa-search"></i> Verificar Eventos Próximos
                </button>
                <div class="data-content" id="notificationStatus">
                    Clique em "Ativar Notificações" para habilitar o sistema
                </div>
            </div>
            
            <div class="data-section">
                <h2><i class="fas fa-calendar-check"></i> Próximos Eventos</h2>
                <button class="btn" onclick="loadUpcomingEvents()">
                    <i class="fas fa-sync"></i> Atualizar Lista
                </button>
                <div class="data-content" id="upcomingEvents">
                    Clique em "Atualizar Lista" para ver os próximos eventos
                </div>
            </div>
            
            <div class="data-section">
                <h2><i class="fas fa-history"></i> Histórico de Notificações</h2>
                <button class="btn" onclick="loadNotificationHistory()">
                    <i class="fas fa-download"></i> Carregar Histórico
                </button>
                <button class="btn btn-danger" onclick="clearNotificationHistory()">
                    <i class="fas fa-trash"></i> Limpar Histórico
                </button>
                <div class="data-content" id="notificationHistory">
                    Clique em "Carregar Histórico" para exibir as notificações anteriores
                </div>
            </div>
        </section>
    </div>

    <div class="notification-bell" onclick="showRecentNotifications()">
        <i class="fas fa-bell"></i>
        <span class="badge" id="notificationCount">0</span>
    </div>

    <script>
        // Variáveis globais
        let notificationTimer = null;
        const NOTIFICATION_CHECK_INTERVAL = 30000; // Verificar a cada 30 segundos
        
        // Função para mostrar mensagens
        function showMessage(message, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = message;
            messageEl.className = `message ${type}`;
            setTimeout(() => {
                messageEl.textContent = '';
                messageEl.className = 'message';
            }, 3000);
        }
        
        // Formatar JSON para exibição
        function formatJSON(data) {
            return JSON.stringify(data, null, 2);
        }
        
        // Ativar o sistema de notificações
        function enableNotifications() {
            // Verificar se o usuário está logado
            const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
            if (!usuarioLogado) {
                showMessage('Você precisa estar logado para ativar as notificações', 'error');
                return;
            }
            
            // Iniciar a verificação de notificações
            startNotificationChecker();
            
            // Atualizar status
            document.getElementById('notificationStatus').textContent = 
                'Sistema de notificações ativado com sucesso!\n' +
                'Próxima verificação em 30 segundos.\n' +
                'Notificações serão exibidas para eventos que acontecerão amanhã.';
                
            showMessage('Sistema de notificações ativado com sucesso!', 'success');
            
            // Fazer uma verificação imediata
            checkUpcomingEvents();
        }
        
        // Iniciar a verificação periódica de notificações
        function startNotificationChecker() {
            // Parar qualquer verificador anterior
            if (notificationTimer) {
                clearInterval(notificationTimer);
            }
            
            // Iniciar novo verificador
            notificationTimer = setInterval(() => {
                checkUpcomingEvents();
            }, NOTIFICATION_CHECK_INTERVAL);
        }
        
        // Verificar eventos próximos
        function checkUpcomingEvents() {
            const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
            if (!usuarioLogado) {
                return; // Não fazer nada se não estiver logado
            }
            
            const events = JSON.parse(localStorage.getItem('events')) || [];
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            // Formatar datas para comparação (ignorando horário)
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            // Encontrar eventos que acontecerão amanhã
            const upcomingEvents = events.filter(event => {
                const eventDate = new Date(event.date);
                const eventDateStr = eventDate.toISOString().split('T')[0];
                return eventDateStr === tomorrowStr;
            });
            
            // Verificar se já notificamos sobre esses eventos hoje
            const notificationHistory = JSON.parse(localStorage.getItem('notificationHistory')) || {};
            const todayStr = now.toISOString().split('T')[0];
            
            // Mostrar notificações para eventos que ainda não foram notificados hoje
            upcomingEvents.forEach(event => {
                const eventId = event.date + event.subject;
                
                if (!notificationHistory[eventId] || notificationHistory[eventId] !== todayStr) {
                    // Mostrar notificação
                    showNotification(event);
                    
                    // Registrar no histórico
                    notificationHistory[eventId] = todayStr;
                    localStorage.setItem('notificationHistory', JSON.stringify(notificationHistory));
                    
                    // Atualizar contador de notificações
                    updateNotificationCount();
                }
            });
            
            return upcomingEvents;
        }
        
        // Mostrar uma notificação na tela
        function showNotification(event) {
            const notification = document.createElement('div');
            notification.className = `notification ${event.type}`;
            
            const icon = event.type === 'prova' ? 'fa-file-alt' : 'fa-tasks';
            const typeText = event.type === 'prova' ? 'Prova' : 'Trabalho';
            
            notification.innerHTML = `
                <i class="fas ${icon}"></i>
                <div>
                    <strong>${typeText}: ${event.subject}</strong>
                    <p>Amanhã: ${event.description || 'Sem descrição'}</p>
                </div>
                <span class="close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </span>
            `;
            
            document.body.appendChild(notification);
            
            // Mostrar a notificação com animação
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Ocultar automaticamente após 10 segundos
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.parentElement.removeChild(notification);
                    }
                }, 300);
            }, 10000);
            
            // Adicionar ao histórico recente
            addToRecentNotifications(event);
        }
        
        // Adicionar notificação ao histórico recente
        function addToRecentNotifications(event) {
            const recentNotifications = JSON.parse(localStorage.getItem('recentNotifications')) || [];
            
            // Manter apenas as 10 notificações mais recentes
            if (recentNotifications.length >= 10) {
                recentNotifications.pop();
            }
            
            // Adicionar nova notificação no início
            recentNotifications.unshift({
                type: event.type,
                subject: event.subject,
                description: event.description,
                date: new Date().toISOString(),
                eventDate: event.date
            });
            
            localStorage.setItem('recentNotifications', JSON.stringify(recentNotifications));
            updateNotificationCount();
        }
        
        // Atualizar contador de notificações
        function updateNotificationCount() {
            const recentNotifications = JSON.parse(localStorage.getItem('recentNotifications')) || [];
            document.getElementById('notificationCount').textContent = recentNotifications.length;
        }
        
        // Mostrar notificações recentes
        function showRecentNotifications() {
            const recentNotifications = JSON.parse(localStorage.getItem('recentNotifications')) || [];
            
            if (recentNotifications.length === 0) {
                showMessage('Não há notificações recentes', 'warning');
                return;
            }
            
            // Limpar notificações atuais
            document.querySelectorAll('.notification').forEach(notification => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.parentElement.removeChild(notification);
                    }
                }, 300);
            });
            
            // Mostrar notificações recentes
            recentNotifications.forEach(event => {
                showNotification(event);
            });
        }
        
        // Testar uma notificação
        function testNotification() {
            const testEvent = {
                type: 'prova',
                subject: 'Matemática',
                description: 'Teste de notificação',
                date: new Date(Date.now() + 86400000).toISOString() // Amanhã
            };
            
            showNotification(testEvent);
            showMessage('Notificação de teste exibida!', 'success');
        }
        
        // Carregar eventos próximos
        function loadUpcomingEvents() {
            const upcomingEvents = checkUpcomingEvents();
            
            if (upcomingEvents.length === 0) {
                document.getElementById('upcomingEvents').textContent = 
                    'Nenhum evento encontrado para amanhã.';
            } else {
                document.getElementById('upcomingEvents').textContent = 
                    formatJSON(upcomingEvents);
            }
            
            showMessage('Eventos próximos carregados com sucesso!', 'success');
        }
        
        // Carregar histórico de notificações
        function loadNotificationHistory() {
            const notificationHistory = JSON.parse(localStorage.getItem('notificationHistory')) || {};
            document.getElementById('notificationHistory').textContent = 
                Object.keys(notificationHistory).length > 0
                ? formatJSON(notificationHistory)
                : 'Nenhuma notificação foi registrada ainda.';
                
            showMessage('Histórico de notificações carregado!', 'success');
        }
        
        // Limpar histórico de notificações
        function clearNotificationHistory() {
            if (confirm('Tem certeza que deseja limpar o histórico de notificações?')) {
                localStorage.removeItem('notificationHistory');
                localStorage.removeItem('recentNotifications');
                document.getElementById('notificationHistory').textContent = 
                    'Histórico de notificações limpo.';
                updateNotificationCount();
                showMessage('Histórico de notificações limpo com sucesso!', 'success');
            }
        }
        
        // Inicializar a página
        window.onload = function() {
            // Verificar se o usuário está logado
            const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
            if (usuarioLogado) {
                // Iniciar verificador de notificações se o usuário estiver logado
                startNotificationChecker();
                
                // Fazer uma verificação imediata
                setTimeout(() => {
                    checkUpcomingEvents();
                }, 2000);
            }
            
            // Atualizar contador de notificações
            updateNotificationCount();
            
            // Carregar status
            document.getElementById('notificationStatus').textContent = 
                usuarioLogado 
                ? 'Sistema de notificações pronto. As notificações serão verificadas automaticamente.'
                : 'Você precisa fazer login para ativar as notificações.';
        };
    </script>
</body>
</html>